import { useState } from 'react'
import styles from './App.module.css'
import ImageUpload from './components/ImageUpload'
import LoadingSpinner from './components/LoadingSpinner'
import ResultsView from './components/ResultsView'
import ReviewForm from './components/ReviewForm'
import ChatPanel from './components/ChatPanel'
import { apiClient } from './api/client'

// Environment configuration
const POLL_INTERVAL = parseInt(import.meta.env.VITE_POLL_INTERVAL || '2000', 10)

export interface VinylRecord {
  record_id: string
  id?: string
  status: string
  artist?: string
  title?: string
  year?: number
  label?: string
  catalog_number?: string
  genres?: string[]
  confidence: number
  auto_commit: boolean
  needs_review: boolean
  evidence_chain: unknown[]
  error?: string
  metadata?: {
    artist?: string
    title?: string
    year?: number
    label?: string
    catalog_number?: string
    genres?: string[]
  }
  created_at?: string
  updated_at?: string
  user_notes?: string | null
}

function App() {
  const [recordId, setRecordId] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const [record, setRecord] = useState<VinylRecord | null>(null)
  const [error, setError] = useState<string | null>(null)
  const [pollInterval, setPollInterval] = useState<any>(null)
  const [uploadedImages, setUploadedImages] = useState<File[]>([])

  const handleUpload = async (files: File[]) => {
    setLoading(true)
    setError(null)
    setUploadedImages(files)
    try {
      console.log('[App] Uploading files:', files)
      const response = await apiClient.identify(files)
      console.log('[App] Upload successful, recordId:', response.record_id || response.id)
      const newRecordId = response.record_id || response.id
      setRecordId(newRecordId || '')
      
      // Clear any existing polling interval
      if (pollInterval) {
        clearInterval(pollInterval)
      }
      
      // Start polling for results
      const interval = setInterval(async () => {
        try {
          console.log('[App] Polling for results...')
          const result = await apiClient.getResult(newRecordId || '')
          console.log('[App] Got result:', result)
          setRecord(result as unknown as VinylRecord)
          
          if (result.status === 'complete' || result.status === 'failed') {
            clearInterval(interval)
            setLoading(false)
          }
        } catch (err) {
          console.error('[App] Polling error:', err)
        }
      }, POLL_INTERVAL)
      
      setPollInterval(interval)
    } catch (err) {
      console.error('[App] Upload error:', err)
      setError(err instanceof Error ? err.message : 'Upload failed')
      setLoading(false)
    }
  }

  // Handler for single image analysis (used by ResultsView)
  const handleAnalyzeSingleImage = (file: File, imageId: string) => {
    console.log('[App] Analyzing single image:', imageId)
    handleUpload([file])
  }

  const handleImagesChange = (updatedImages: File[]) => {
    setUploadedImages(updatedImages)
  }

  const handleReview = async (corrections: Record<string, unknown>) => {
    if (!recordId) return
    
    setLoading(true)
    setError(null)
    try {
      const updated = await apiClient.review(recordId, corrections)
      setRecord(updated as unknown as VinylRecord)
      setLoading(false)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Review submission failed')
      setLoading(false)
    }
  }

  const handleReset = () => {
    setRecordId(null)
    setRecord(null)
    setError(null)
    setLoading(false)
    setUploadedImages([])
    if (pollInterval) {
      clearInterval(pollInterval)
    }
  }

  const handleRedoRecognition = () => {
    if (uploadedImages.length > 0) {
      setRecord(null)
      setLoading(true)
      handleUpload(uploadedImages)
    }
  }

  return (
    <div className={styles.container}>
      <header className={styles.header}>
        <h1>Phonox - Vinyl Record Identifier</h1>
        <p>Upload images of your vinyl records for AI-powered identification</p>
      </header>

      <div className={styles.mainWrapper}>
        <main className={styles.main}>
          {error && (
            <div className={styles.error}>
              <button onClick={() => setError(null)}>&times;</button>
              {error}
            </div>
          )}

          {!record && !loading && (
            <ImageUpload 
              onUpload={handleUpload}
              onAnalyzeSingle={(file) => handleUpload([file])}
            />
          )}

          {loading && <LoadingSpinner />}

          {record && (
            <>
              <ResultsView 
                record={record} 
                uploadedImages={uploadedImages}
                onRedoRecognition={handleRedoRecognition}
                onImagesChange={handleImagesChange}
                onAnalyzeSingle={handleAnalyzeSingleImage}
              />
              
              {record.needs_review && !record.auto_commit && (
                <ReviewForm recordId={recordId || ''} onReview={handleReview} />
              )}
              
              <button onClick={handleReset} className={styles.resetButton}>
                Identify Another Record
              </button>
            </>
          )}
        </main>

        <aside className={styles.chatSidebar}>
          {recordId && record ? (
            <ChatPanel
              recordId={recordId}
              currentMetadata={{
                artist: record.metadata?.artist || record.artist,
                title: record.metadata?.title || record.title,
                year: record.metadata?.year || record.year,
                label: record.metadata?.label || record.label,
                catalog_number: record.metadata?.catalog_number || record.catalog_number,
                genres: record.metadata?.genres || record.genres,
              }}
              onMetadataUpdate={(metadata) => {
                setRecord((prev) =>
                  prev
                    ? {
                        ...prev,
                        metadata: {
                          artist: (metadata.artist as string) || prev.metadata?.artist || prev.artist,
                          title: (metadata.title as string) || prev.metadata?.title || prev.title,
                          year: (metadata.year as number) || prev.metadata?.year || prev.year,
                          label: (metadata.label as string) || prev.metadata?.label || prev.label,
                          catalog_number: (metadata.catalog_number as string) || prev.metadata?.catalog_number || prev.catalog_number,
                          genres: (metadata.genres as string[]) || prev.metadata?.genres || prev.genres,
                        },
                      }
                    : null,
                )
              }}
              onClose={undefined}
            />
          ) : (
            <div className={styles.chatPlaceholder}>
              <h2>Chat</h2>
              <p>Upload a vinyl record image to start chatting about it</p>
            </div>
          )}
        </aside>
      </div>

      <footer className={styles.footer}>
        <p>&copy; 2024 Phonox. AI-powered vinyl record identification.</p>
      </footer>
    </div>
  )
}

export default App
