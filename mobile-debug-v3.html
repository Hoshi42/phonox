<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phonox Mobile Debug v3</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        input[type="file"] {
            padding: 10px;
            margin: 10px 0;
            border: 2px dashed #ccc;
            border-radius: 4px;
            width: 100%;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Phonox Mobile Debug v3</h1>
    
    <div class="debug-panel">
        <h2>Device Information</h2>
        <div id="deviceInfo"></div>
    </div>

    <div class="debug-panel">
        <h2>Network Tests</h2>
        <button onclick="testConnectivity()">Test All Connectivity</button>
        <button onclick="clearLog()">Clear Log</button>
        <div id="networkStatus"></div>
    </div>

    <div class="debug-panel">
        <h2>Upload Test</h2>
        <input type="file" id="fileInput" multiple accept="image/*">
        <button onclick="testUpload()">Test Upload</button>
        <div id="uploadStatus"></div>
    </div>

    <div class="debug-panel">
        <h2>Debug Log</h2>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        const log = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            log.push(logEntry);
            console.log(logEntry);
            
            const logDiv = document.getElementById('debugLog');
            const logItem = document.createElement('div');
            logItem.textContent = logEntry;
            logItem.className = type;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            log.length = 0;
            document.getElementById('debugLog').innerHTML = '';
        }

        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showDeviceInfo() {
            const info = {
                userAgent: navigator.userAgent,
                hostname: window.location.hostname,
                port: window.location.port,
                protocol: window.location.protocol,
                isMobile: /Mobi|Android/i.test(navigator.userAgent),
                cookiesEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                language: navigator.language
            };
            
            let html = '';
            for (const [key, value] of Object.entries(info)) {
                html += `<strong>${key}:</strong> ${value}<br>`;
            }
            document.getElementById('deviceInfo').innerHTML = html;
            
            addLog(`Device: ${info.isMobile ? 'Mobile' : 'Desktop'}, Online: ${info.onLine}, Host: ${info.hostname}`);
        }

        async function testUrl(url, description) {
            addLog(`Testing ${description}: ${url}`);
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    addLog(`✅ ${description} OK: ${response.status}`, 'success');
                    return { success: true, data };
                } else {
                    addLog(`❌ ${description} Failed: ${response.status} ${response.statusText}`, 'error');
                    return { success: false, error: `${response.status} ${response.statusText}` };
                }
            } catch (error) {
                addLog(`❌ ${description} Error: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function testConnectivity() {
            setStatus('networkStatus', 'Testing connectivity...', 'info');
            addLog('Starting connectivity tests...');
            
            const tests = [
                { url: `http://${window.location.hostname}:8000/health`, desc: 'Backend Health' },
                { url: `http://${window.location.hostname}:8000/`, desc: 'Backend Root' },
                { url: `http://${window.location.hostname}:5173/`, desc: 'Frontend' },
                { url: 'http://172.21.83.112:8000/health', desc: 'Direct IP Backend' },
                { url: 'https://httpbin.org/get', desc: 'External API (HTTPS)' },
                { url: 'http://httpbin.org/get', desc: 'External API (HTTP)' }
            ];
            
            let results = [];
            for (const test of tests) {
                const result = await testUrl(test.url, test.desc);
                results.push({ ...test, ...result });
            }
            
            let statusHtml = '<h3>Connectivity Results:</h3>';
            let allGood = true;
            
            results.forEach(result => {
                const status = result.success ? 'success' : 'error';
                const icon = result.success ? '✅' : '❌';
                statusHtml += `<div class="test-result ${status}">${icon} ${result.desc}: ${result.success ? 'OK' : result.error}</div>`;
                if (!result.success) allGood = false;
            });
            
            if (allGood) {
                statusHtml += '<div class="status success">All connectivity tests passed!</div>';
            } else {
                statusHtml += '<div class="status error">Some connectivity issues detected. Check the log for details.</div>';
            }
            
            setStatus('networkStatus', statusHtml, allGood ? 'success' : 'error');
        }

        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (!files.length) {
                setStatus('uploadStatus', 'Please select at least one image file', 'warning');
                return;
            }
            
            setStatus('uploadStatus', 'Testing upload...', 'info');
            addLog(`Starting upload test with ${files.length} file(s)`);
            
            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                    addLog(`Added file: ${files[i].name} (${files[i].size} bytes)`);
                }
                
                const apiUrl = `http://${window.location.hostname}:8000/api/v1/identify`;
                addLog(`Uploading to: ${apiUrl}`);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.json();
                    addLog(`✅ Upload successful! Record ID: ${result.record_id}`, 'success');
                    setStatus('uploadStatus', `Upload successful! Record ID: ${result.record_id}`, 'success');
                } else {
                    const errorText = await response.text();
                    addLog(`❌ Upload failed: ${response.status} ${response.statusText} - ${errorText}`, 'error');
                    setStatus('uploadStatus', `Upload failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                addLog(`❌ Upload error: ${error.message}`, 'error');
                setStatus('uploadStatus', `Upload error: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        window.onload = function() {
            showDeviceInfo();
            addLog('Mobile debug tool loaded');
        };
    </script>
</body>
</html>