<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile CORS Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; margin: 15px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { padding: 12px 20px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 12px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap; border-left: 4px solid #007bff; }
        .error { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
        .success { background: #d4edda; border-left-color: #28a745; color: #155724; }
        .warning { background: #fff3cd; border-left-color: #ffc107; color: #856404; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; color: #0c5460; }
        h1 { color: #333; }
        h2 { color: #555; margin-top: 25px; }
        .url-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîç Mobile CORS Debug Tool</h1>
    
    <div class="url-info">
        <strong>Current Page URL:</strong> <span id="currentUrl"></span><br>
        <strong>Hostname:</strong> <span id="hostname"></span><br>
        <strong>Port:</strong> <span id="port"></span><br>
        <strong>Origin:</strong> <span id="origin"></span>
    </div>

    <div class="test-section">
        <h2>üåê Network Environment</h2>
        <button onclick="checkNetworkInfo()">Check Network Info</button>
        <div id="network-results"></div>
    </div>

    <div class="test-section">
        <h2>üè• Health Check Test</h2>
        <button onclick="testHealth()">Test Backend Health</button>
        <div id="health-results"></div>
    </div>

    <div class="test-section">
        <h2>üéµ Register API Test</h2>
        <button onclick="testRegisterAPI()">Test Register for Jan</button>
        <div id="register-results"></div>
    </div>

    <div class="test-section">
        <h2>üîß CORS Preflight Test</h2>
        <button onclick="testCORSPreflight()">Test CORS Preflight</button>
        <div id="cors-results"></div>
    </div>

    <div class="test-section">
        <h2>üì° Fetch API Test</h2>
        <button onclick="testFetchAPI()">Test with Different Fetch Options</button>
        <div id="fetch-results"></div>
    </div>

    <script>
        // Initialize page info
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('port').textContent = window.location.port || '80';
            document.getElementById('origin').textContent = window.location.origin;
        });

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logDiv);
            container.scrollTop = container.scrollHeight;
        }

        function clear(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function checkNetworkInfo() {
            clear('network-results');
            log('network-results', 'üîç Checking network environment...', 'info');
            
            // Basic browser info
            log('network-results', `User Agent: ${navigator.userAgent}`, 'info');
            log('network-results', `Online: ${navigator.onLine}`, 'info');
            log('network-results', `Language: ${navigator.language}`, 'info');
            
            // Connection info if available
            if ('connection' in navigator) {
                const conn = navigator.connection;
                log('network-results', `Connection Type: ${conn.effectiveType || 'unknown'}`, 'info');
            }
            
            // Expected API URLs
            const apiBase = `http://${window.location.hostname}:8000`;
            log('network-results', `Expected API Base: ${apiBase}`, 'warning');
            log('network-results', `CORS Origin Check: ${window.location.origin} -> ${apiBase}`, 'warning');
        }

        async function testHealth() {
            clear('health-results');
            log('health-results', 'üè• Testing backend health endpoint...', 'info');
            
            const apiUrl = `http://${window.location.hostname}:8000/health`;
            log('health-results', `Testing URL: ${apiUrl}`, 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                log('health-results', `Response Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log('health-results', `Response Time: ${responseTime}ms`, 'info');
                log('health-results', `Response Headers:`, 'info');
                
                for (const [key, value] of response.headers.entries()) {
                    log('health-results', `  ${key}: ${value}`, 'info');
                }
                
                if (response.ok) {
                    const data = await response.json();
                    log('health-results', `Response Data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log('health-results', `Error Response: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log('health-results', `‚ùå Fetch Error: ${error.name}`, 'error');
                log('health-results', `Error Message: ${error.message}`, 'error');
                log('health-results', `Error Stack: ${error.stack}`, 'error');
                
                // Check if it's a CORS error
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    log('health-results', 'üö® This looks like a CORS or network connectivity error!', 'error');
                }
            }
        }

        async function testRegisterAPI() {
            clear('register-results');
            log('register-results', 'üéµ Testing register API for Jan...', 'info');
            
            const apiUrl = `http://${window.location.hostname}:8000/api/register/?user_tag=Jan&_t=${Date.now()}`;
            log('register-results', `Testing URL: ${apiUrl}`, 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                log('register-results', `Response Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log('register-results', `Response Time: ${responseTime}ms`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log('register-results', `‚úÖ Success! Found ${data.length} records for Jan`, 'success');
                    
                    if (data.length > 0) {
                        data.forEach((record, index) => {
                            log('register-results', `Record ${index + 1}: ${record.artist} - ${record.title} (${record.year || 'Unknown year'})`, 'success');
                        });
                    }
                } else {
                    const errorText = await response.text();
                    log('register-results', `‚ùå API Error: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log('register-results', `‚ùå Fetch Error: ${error.name}`, 'error');
                log('register-results', `Error Message: ${error.message}`, 'error');
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    log('register-results', 'üö® CORS or connectivity issue detected!', 'error');
                }
            }
        }

        async function testCORSPreflight() {
            clear('cors-results');
            log('cors-results', 'üîß Testing CORS preflight...', 'info');
            
            const apiUrl = `http://${window.location.hostname}:8000/api/register/`;
            log('cors-results', `Testing OPTIONS request to: ${apiUrl}`, 'info');
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'OPTIONS',
                    mode: 'cors',
                    headers: {
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                log('cors-results', `OPTIONS Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log('cors-results', 'CORS Headers:', 'info');
                
                const corsHeaders = [
                    'Access-Control-Allow-Origin',
                    'Access-Control-Allow-Methods',
                    'Access-Control-Allow-Headers',
                    'Access-Control-Allow-Credentials',
                    'Access-Control-Max-Age'
                ];
                
                corsHeaders.forEach(header => {
                    const value = response.headers.get(header);
                    if (value) {
                        log('cors-results', `  ${header}: ${value}`, 'success');
                    } else {
                        log('cors-results', `  ${header}: NOT SET`, 'warning');
                    }
                });
                
            } catch (error) {
                log('cors-results', `‚ùå CORS Preflight Failed: ${error.message}`, 'error');
            }
        }

        async function testFetchAPI() {
            clear('fetch-results');
            log('fetch-results', 'üì° Testing different fetch configurations...', 'info');
            
            const apiUrl = `http://${window.location.hostname}:8000/api/register/users`;
            
            const testConfigs = [
                {
                    name: 'Default CORS',
                    options: { method: 'GET', mode: 'cors' }
                },
                {
                    name: 'No-CORS mode',
                    options: { method: 'GET', mode: 'no-cors' }
                },
                {
                    name: 'Same-origin mode',
                    options: { method: 'GET', mode: 'same-origin' }
                },
                {
                    name: 'With credentials',
                    options: { method: 'GET', mode: 'cors', credentials: 'include' }
                }
            ];
            
            for (const config of testConfigs) {
                log('fetch-results', `\nüß™ Testing: ${config.name}`, 'warning');
                
                try {
                    const response = await fetch(apiUrl, config.options);
                    log('fetch-results', `Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                    
                    if (config.options.mode !== 'no-cors' && response.ok) {
                        const data = await response.json();
                        log('fetch-results', `Response: ${JSON.stringify(data)}`, 'success');
                    }
                    
                } catch (error) {
                    log('fetch-results', `‚ùå ${config.name} failed: ${error.message}`, 'error');
                }
            }
        }
    </script>
</body>
</html>