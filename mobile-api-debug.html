<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile API Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 15px; background: #f0f8ff; }
        .section { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 8px; margin: 5px 0; border-radius: 3px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        h1 { color: #333; text-align: center; margin: 0 0 20px 0; }
        h3 { color: #555; margin: 15px 0 10px 0; }
    </style>
</head>
<body>
    <h1>üîç Mobile Register API Debug</h1>
    
    <div class="section">
        <h3>üì± Environment Info</h3>
        <div id="env-info"></div>
        <button onclick="showEnvironment()">Show Environment</button>
    </div>
    
    <div class="section">
        <h3>üåê Network Test</h3>
        <div id="network-logs"></div>
        <button onclick="testNetwork()">Test Network</button>
    </div>
    
    <div class="section">
        <h3>üîë API Direct Test</h3>
        <div id="api-logs"></div>
        <button onclick="testRegisterAPI()">Test Register API</button>
    </div>
    
    <div class="section">
        <h3>üéØ Frontend API Test</h3>
        <div id="frontend-logs"></div>
        <button onclick="testFrontendAPI()">Test Frontend API Code</button>
    </div>

    <script>
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logDiv);
            container.scrollTop = container.scrollHeight;
        }

        function clear(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function showEnvironment() {
            clear('env-info');
            log('env-info', `URL: ${window.location.href}`, 'info');
            log('env-info', `Hostname: ${window.location.hostname}`, 'info');
            log('env-info', `Port: ${window.location.port}`, 'info');
            log('env-info', `Origin: ${window.location.origin}`, 'info');
            log('env-info', `User Agent: ${navigator.userAgent}`, 'info');
            log('env-info', `Online: ${navigator.onLine}`, 'info');
            log('env-info', `Language: ${navigator.language}`, 'info');
            
            // Expected API URL
            const expectedAPI = `http://${window.location.hostname}:8000`;
            log('env-info', `Expected API: ${expectedAPI}`, 'warning');
        }

        async function testNetwork() {
            clear('network-logs');
            log('network-logs', 'üåê Testing network connectivity...', 'info');
            
            const apiBase = `http://${window.location.hostname}:8000`;
            
            // Test 1: Health endpoint
            try {
                log('network-logs', 'Testing health endpoint...', 'info');
                const response = await fetch(`${apiBase}/health`, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('network-logs', `‚úÖ Health check OK: ${JSON.stringify(data)}`, 'success');
                } else {
                    log('network-logs', `‚ùå Health check failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log('network-logs', `‚ùå Health check error: ${error.message}`, 'error');
            }
            
            // Test 2: CORS preflight
            try {
                log('network-logs', 'Testing CORS preflight...', 'info');
                const response = await fetch(`${apiBase}/api/register/`, {
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    log('network-logs', '‚úÖ CORS preflight OK', 'success');
                    // Log CORS headers
                    const corsHeaders = ['Access-Control-Allow-Origin', 'Access-Control-Allow-Methods', 'Access-Control-Allow-Headers'];
                    corsHeaders.forEach(header => {
                        const value = response.headers.get(header);
                        log('network-logs', `  ${header}: ${value || 'NOT SET'}`, value ? 'success' : 'warning');
                    });
                } else {
                    log('network-logs', `‚ùå CORS preflight failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log('network-logs', `‚ùå CORS preflight error: ${error.message}`, 'error');
            }
        }

        async function testRegisterAPI() {
            clear('api-logs');
            log('api-logs', 'üîë Testing register API directly...', 'info');
            
            const apiBase = `http://${window.location.hostname}:8000`;
            const tests = [
                { url: `${apiBase}/api/register/users`, desc: 'Users list' },
                { url: `${apiBase}/api/register/?user_tag=Jan&_t=${Date.now()}`, desc: "Jan's register" },
                { url: `${apiBase}/api/register/?_t=${Date.now()}`, desc: 'All records' }
            ];
            
            for (const test of tests) {
                try {
                    log('api-logs', `Testing ${test.desc}: ${test.url}`, 'info');
                    
                    const startTime = Date.now();
                    const response = await fetch(test.url, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const endTime = Date.now();
                    
                    log('api-logs', `Response: ${response.status} ${response.statusText} (${endTime - startTime}ms)`, response.ok ? 'success' : 'error');
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (Array.isArray(data)) {
                            log('api-logs', `‚úÖ Success: ${data.length} items returned`, 'success');
                            if (data.length > 0) {
                                log('api-logs', `Sample: ${JSON.stringify(data[0]).substring(0, 200)}...`, 'info');
                            }
                        } else {
                            log('api-logs', `‚úÖ Success: ${JSON.stringify(data)}`, 'success');
                        }
                    } else {
                        const errorText = await response.text();
                        log('api-logs', `‚ùå Error response: ${errorText}`, 'error');
                    }
                    
                } catch (error) {
                    log('api-logs', `‚ùå ${test.desc} failed: ${error.message}`, 'error');
                    
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        log('api-logs', 'üö® Network/CORS issue detected!', 'error');
                    }
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function testFrontendAPI() {
            clear('frontend-logs');
            log('frontend-logs', 'üéØ Testing frontend API simulation...', 'info');
            
            // Simulate the exact API call the frontend makes
            const API_BASE = (() => {
                if (window.location.hostname) {
                    const fallbackUrl = `http://${window.location.hostname}:8000`;
                    log('frontend-logs', `Using hostname fallback: ${fallbackUrl}`, 'info');
                    return fallbackUrl;
                }
                log('frontend-logs', 'Using localhost fallback', 'warning');
                return 'http://localhost:8000';
            })();
            
            const baseUrl = `${API_BASE}/api/register`;
            log('frontend-logs', `Frontend API base URL: ${baseUrl}`, 'info');
            
            // Test the exact call the frontend makes
            const userTag = 'Jan';
            const url = `${baseUrl}/?user_tag=${encodeURIComponent(userTag)}&_t=${Date.now()}`;
            log('frontend-logs', `Frontend API URL: ${url}`, 'info');
            
            try {
                log('frontend-logs', 'Making frontend-style API call...', 'info');
                
                const isMobile = /Mobi|Android/i.test(navigator.userAgent);
                const cacheHeaders = {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                };
                
                if (isMobile) {
                    cacheHeaders['X-Mobile-Cache-Bust'] = Date.now().toString();
                    log('frontend-logs', 'Added mobile cache busting headers', 'info');
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...cacheHeaders
                    },
                    cache: 'no-cache'
                });
                
                log('frontend-logs', `Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log('frontend-logs', `Headers sent: ${JSON.stringify(cacheHeaders)}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('frontend-logs', `‚ùå API Error: ${errorText}`, 'error');
                    return;
                }
                
                const data = await response.json();
                log('frontend-logs', `‚úÖ Success! Received ${data.length} records`, 'success');
                
                if (data.length > 0) {
                    data.forEach((record, index) => {
                        log('frontend-logs', `Record ${index + 1}: ${record.artist} - ${record.title}`, 'success');
                    });
                } else {
                    log('frontend-logs', '‚ö†Ô∏è No records returned for Jan!', 'warning');
                }
                
            } catch (error) {
                log('frontend-logs', `‚ùå Frontend API call failed: ${error.message}`, 'error');
                log('frontend-logs', `Error type: ${error.name}`, 'error');
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    log('frontend-logs', 'üö® This is the same error the frontend is getting!', 'error');
                    log('frontend-logs', 'Possible causes:', 'warning');
                    log('frontend-logs', '1. CORS policy blocking the request', 'warning');
                    log('frontend-logs', '2. Network connectivity issue', 'warning');
                    log('frontend-logs', '3. Backend not accessible from mobile browser', 'warning');
                }
            }
        }
    </script>
</body>
</html>